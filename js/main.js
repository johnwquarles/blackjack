"use strict";

var API_URL = "http://deckofcardsapi.com/api";
var API_PROXY = "https://jsonp.afeld.me/?url=";
var game;
var CARD_BACK_URL = "/images/back.png";
var $DEALERHAND = $(".dealer-hand");
var $PLAYERHAND = $(".player-hand");
var $PLAYERCONTROLS = $(".player-controls");
var $DEALERMSG = $(".dealer-msg");
var $PLAYERMSG = $(".player-msg");
var $PLAYERWRAPPER = $(".player-wrapper");
var $MSGAREA = $(".msg-area");

// time between dealer's individual turns
var DEALER_TURN_DELAY = 1500;

// time between each individual card flip once flipping has begun
var CASCADE_FLIP_TIME = 400;

$PLAYERWRAPPER.on("click", ".hit-btn", function (event) {
  event.preventDefault();
  dealCards("player", 1, playerLoop);
}).on("click", ".stick-btn", function (event) {
  event.preventDefault();
  dealerInitialTurn();
}).on("click", ".newgame", function (event) {
  event.preventDefault();
  startGame();
});

startGame();

// to start off the game, make a new game object (with attributes that will preserve the game's state, ie, who has what cards) and then
// ask the API for a deck ID to assign to the game object's deck (we need to use it for subsequent calls to the API, when we ask it for cards from
// our deck).
// We can't do anything until we have that deck ID, but the program would happily continue on prior to actually loading the object that contains the
// deck ID. So we need a way to make it wait until that object has successfully loaded-- we do so by making the next step in the program, which
// is the dealer's initial turn, fire as part of the setDeckID function's callback function. That way it won't happen until it has the requisite data.
function startGame() {
  game = new Game();
  $PLAYERCONTROLS.empty();
  $DEALERHAND.empty();
  $PLAYERHAND.empty();
  $MSGAREA.empty();
  setDeckId(playerInitialTurn);
}

// setting up a game object to preserve the game's state. This is a constructor function that is invoked above via "game = new Game();" to
// generate a game object with all of the attributes listed below.
function Game() {
  this.deck_id = "";
  this.dealer_cards = [];
  this.player_cards = [];
  this.playertotal = 0;
  this.dealertotal = 0;
}

// set the the game object's deck_id by calling the API and looking at the deck_id attribute of the response it gives us.
// After the data has loaded (and written to the game object), our callback function fires off, which we've set up to be whatever function we pass in.
// We pass in playerInitialTurn (line 44) so that the game starts.

function setDeckId(callback) {
  $.get(API_PROXY + API_URL + "/shuffle/?deck_count=6", function (obj) {
    game.deck_id = obj.deck_id;
    callback();
  }, "json");
}

// specify "player" or "dealer" and how many cards. Their array will be populated with the cards (via array concatenation)
// and the total updated (will make Aces worth
// 1 instead of 11 if it will prevent busting; see subsequent functions for details on how this happens.
// http://deckofcardsapi.com/ shows what the response object looks like; check under "draw a card".
function dealCards(towhom, num, callback) {
  var get_url = API_PROXY + API_URL + "/draw/" + game.deck_id + "/?count=" + num;
  $.get(get_url, function (obj) {
    if (towhom.toLowerCase() === "player") {
      game.player_cards = game.player_cards.concat(obj.cards);
      insertPlayerCards(obj.cards);
      updateTotal("player");
    } else {
      game.dealer_cards = game.dealer_cards.concat(obj.cards);
      insertDealerCards(obj.cards);
      updateTotal("dealer");
    }
    callback();
  }, "json");
}

// enter "player" or "dealer". It will sum up the total of the cards,
// with aces moved to the back so that the computer can decide to count them as
// 1 if it will prevent busting. The new total is written to the game object. This doesn't modify the original
// card order; don't want to do that, because we want to keep the order for display purposes.
// so doing .slice() on the card arrays will let us make the acesToBack-ed arrays from copies.
function updateTotal(whom) {
  var cards = whom.toLowerCase() === "player" ? game.player_cards.slice() : game.dealer_cards.slice();
  var total = acesToBack(cards).reduce(function (acc, card) {
    if (card.value === "KING" || card.value === "QUEEN" || card.value === "JACK") {
      return acc + 10;
    } else if (card.value === "ACE") {
      if (acc + 11 < 22) {
        return acc + 11;
      } else {
        return acc + 1;
      }
    } else {
      return acc + parseInt(card.value);
    }
  }, 0);
  whom.toLowerCase() === "player" ? game.playertotal = total : game.dealertotal = total;
}

// aces to back of array for summation purposes.
// Look at all cards; ace? If so move it to the back. Not ace? Move it to the front.
function acesToBack(arr) {
  var return_arr = [];
  arr.forEach(function (card) {
    if (card.value === "ACE") {
      return_arr.push(card);
    } else {
      return_arr.unshift(card);
    }
  });
  return return_arr;
}

// Dealer's first turn. Deal 2 cards to the dealer, and after the data is loaded, invoke dealerLoop as the callback function.
// Note that the player actually goes first; code is in this order because I got that wrong at first.
function dealerInitialTurn() {
  dealCards("dealer", 2, dealerLoop);
}

// Make dealer's turns go slower (ie, not instantaneously) so that it feels like a card game is actually being played out;
// do so by setting a timeout on each subsequent function call (ie, each *next* dealer turn) that delays that next turn by
// DEALER_TURN_DELAY milliseconds; adjust this constant from the top of this file.
function dealerLoop() {
  if (game.dealertotal < 17) {
    setTimeout(function () {
      dealCards("dealer", 1, dealerLoop);
    }, DEALER_TURN_DELAY);
  } else {
    setTimeout(function () {
      dealerTurnResult();
    }, DEALER_TURN_DELAY);
  }
}

function make$P(string) {
  return $("<p>" + string + "</p>").addClass("animated fadeIn");
}

function dealerTurnResult() {
  if (game.dealertotal === 21) {
    flipDealerCards();
    $MSGAREA.append(make$P("Blackjack!").removeClass("fadeIn").addClass("flash")).append(make$P(" Dealer wins!").addClass("lose"));
    appendNewGameButton();
  } else if (game.dealertotal > 21) {
    flipDealerCards();
    $MSGAREA.append(make$P("Dealer busts!")).append(make$P(" You win!").addClass("win"));
    appendNewGameButton();
  } else {
    finalReckoning();
  }
}

// p. much the same thing for the player, except it's up to him/her whether or not to hit.
function playerInitialTurn() {
  dealCards("player", 2, playerLoop);
}

function playerLoop() {
  flipPlayerCards();
  if (game.playertotal === 21) {
    $MSGAREA.append(make$P("Blackjack!").removeClass("fadeIn").addClass("flash")).append(make$P(" You win!").addClass("win"));
    appendNewGameButton();
  } else if (game.playertotal > 21) {
    $MSGAREA.append(make$P("You busted!").removeClass("fadeIn").addClass("swing")).append(make$P(" You lose!").addClass("lose"));
    appendNewGameButton();
  } else {
    appendControlsAndWait();
  }
}
// if the neither the dealer nor the player won outright or busted during their respective turns, we need to compare the totals
// to see who won.
function finalReckoning() {
  $MSGAREA.append(make$P("Your total: " + game.playertotal + "&nbsp; &nbsp; Dealer's total: " + game.dealertotal));
  if (game.playertotal > game.dealertotal) {
    flipDealerCards();
    $MSGAREA.append(make$P("You win!").addClass("win"));
    appendNewGameButton();
  } else if (game.playertotal === game.dealertotal) {
    flipDealerCards();
    $MSGAREA.append(make$P("Tie! You lose!").addClass("lose"));
    appendNewGameButton();
  } else {
    flipDealerCards();
    $MSGAREA.append(make$P("You lose!").addClass("lose"));
    appendNewGameButton();
  }
}

function insertPlayerCards(card_arr) {
  card_arr.forEach(function (card_obj) {
    var $card = generateBack$IMG(card_obj);
    $PLAYERHAND.append($card);
  });
}

function generateFront$IMG(card_obj) {
  if (card_obj.value === "ACE" && card_obj.suit === "DIAMONDS") {
    card_obj.image = "images/AceOfDiamonds.png";
  }
  var $card = $("<img src='" + card_obj.image + "'>");
  return $card;
}

function generateBack$IMG(card_obj) {
  if (card_obj.value === "ACE" && card_obj.suit === "DIAMONDS") {
    card_obj.image = "images/AceOfDiamonds.png";
  }
  var $card = $("<img src='" + CARD_BACK_URL + "' front_url = '" + card_obj.image + "'>");
  return $card;
}

function insertDealerCards(card_arr) {
  card_arr.forEach(function (card_obj, i) {
    if ($DEALERHAND.is(":empty") && i === 0) {
      var $card = generateFront$IMG(card_obj);
      $DEALERHAND.append($card);
    } else {
      var $card = generateBack$IMG(card_obj);
      $DEALERHAND.append($card);
    }
  });
}

// function appendTotal(whom) {
//  var total = whom === "player" ?
//    game.playertotal:
//    game.dealertotal;
//  var $msg_area = whom === "player" ?
//    $PLAYERMSG:
//    $DEALERMSG;
//  var $total = $("<p>Total: " + total + "</p>");
//  $msg_area.empty();
//  $msg_area.append($total);
// }

// append controls and await player decision
function appendControlsAndWait() {
  $PLAYERCONTROLS.empty();
  var $hit = $("<button class='hit-btn'>Hit</button>");
  var $stick = $("<button class='stick-btn'>Stand</button>");
  $PLAYERCONTROLS.append($hit).append($stick);
}

function appendNewGameButton() {
  $PLAYERCONTROLS.empty();
  var $newgame = $("<button class='newgame'>New Game</button>");
  $PLAYERCONTROLS.append($newgame);
}

function flipDealerCards() {
  var img_arr = [].slice.call(document.querySelectorAll(".dealer-hand img"));
  var i = 0;
  var length = img_arr.length;
  function delayedFlip() {
    if (i < length) {
      if (img_arr[i].getAttribute("front_url")) {
        img_arr[i].src = img_arr[i].getAttribute("front_url");
      }
      i += 1;
      setTimeout(function () {
        delayedFlip();
      }, CASCADE_FLIP_TIME);
    }
  }
  delayedFlip();
}

function flipPlayerCards() {
  var img_arr = [].slice.call(document.querySelectorAll(".player-hand img"));
  var i = 0;
  var length = img_arr.length;
  function delayedFlip() {
    if (i < length) {
      img_arr[i].src = img_arr[i].getAttribute("front_url");
    }
    i += 1;
    setTimeout(function () {
      delayedFlip();
    }, CASCADE_FLIP_TIME);
  }
  delayedFlip();
}
//# sourceMappingURL=data:application/json;base64,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Q0FBQztBQUM1QixXQUFTLFdBQVcsR0FBRztBQUNyQixRQUFJLENBQUMsR0FBRyxNQUFNLEVBQUU7QUFDZCxVQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLEVBQUU7QUFDeEMsZUFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO09BQ3ZEO0FBQ0QsT0FBQyxJQUFJLENBQUMsQ0FBQztBQUNQLGdCQUFVLENBQUMsWUFBVTtBQUFDLG1CQUFXLEVBQUUsQ0FBQTtPQUFDLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztLQUMxRDtHQUNGO0FBQ0QsYUFBVyxFQUFFLENBQUM7Q0FDZjs7QUFFRCxTQUFTLGVBQWUsR0FBRztBQUN6QixNQUFJLE9BQU8sR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0FBQzNFLE1BQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNWLE1BQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDNUIsV0FBUyxXQUFXLEdBQUc7QUFDckIsUUFBSSxDQUFDLEdBQUcsTUFBTSxFQUFFO0FBQ1osYUFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ3pEO0FBQ0QsS0FBQyxJQUFJLENBQUMsQ0FBQztBQUNQLGNBQVUsQ0FBQyxZQUFVO0FBQUMsaUJBQVcsRUFBRSxDQUFBO0tBQUMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0dBQzFEO0FBQ0QsYUFBVyxFQUFFLENBQUM7Q0FDZiIsImZpbGUiOiJzcmMvanMvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBBUElfVVJMID0gXCJodHRwOi8vZGVja29mY2FyZHNhcGkuY29tL2FwaVwiO1xudmFyIEFQSV9QUk9YWSA9IFwiaHR0cHM6Ly9qc29ucC5hZmVsZC5tZS8/dXJsPVwiO1xudmFyIGdhbWU7XG52YXIgQ0FSRF9CQUNLX1VSTCA9IFwiL2ltYWdlcy9iYWNrLnBuZ1wiO1xudmFyICRERUFMRVJIQU5EID0gJCgnLmRlYWxlci1oYW5kJyk7XG52YXIgJFBMQVlFUkhBTkQgPSAkKCcucGxheWVyLWhhbmQnKTtcbnZhciAkUExBWUVSQ09OVFJPTFMgPSAkKCcucGxheWVyLWNvbnRyb2xzJyk7XG52YXIgJERFQUxFUk1TRyA9ICQoJy5kZWFsZXItbXNnJyk7XG52YXIgJFBMQVlFUk1TRyA9ICQoJy5wbGF5ZXItbXNnJyk7XG52YXIgJFBMQVlFUldSQVBQRVIgPSAkKCcucGxheWVyLXdyYXBwZXInKTtcbnZhciAkTVNHQVJFQSA9ICQoJy5tc2ctYXJlYScpXG5cbi8vIHRpbWUgYmV0d2VlbiBkZWFsZXIncyBpbmRpdmlkdWFsIHR1cm5zXG52YXIgREVBTEVSX1RVUk5fREVMQVkgPSAxNTAwO1xuXG4vLyB0aW1lIGJldHdlZW4gZWFjaCBpbmRpdmlkdWFsIGNhcmQgZmxpcCBvbmNlIGZsaXBwaW5nIGhhcyBiZWd1blxudmFyIENBU0NBREVfRkxJUF9USU1FID0gNDAwO1xuXG4kUExBWUVSV1JBUFBFUi5vbignY2xpY2snLCAnLmhpdC1idG4nLCBmdW5jdGlvbihldmVudCkge1xuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICBkZWFsQ2FyZHMoXCJwbGF5ZXJcIiwgMSwgcGxheWVyTG9vcCk7XG59KS5vbignY2xpY2snLCAnLnN0aWNrLWJ0bicsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gIGRlYWxlckluaXRpYWxUdXJuKCk7XG59KS5vbignY2xpY2snLCAnLm5ld2dhbWUnLCBmdW5jdGlvbihldmVudCkge1xuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICBzdGFydEdhbWUoKTtcbn0pXG5cbnN0YXJ0R2FtZSgpO1xuXG4vLyB0byBzdGFydCBvZmYgdGhlIGdhbWUsIG1ha2UgYSBuZXcgZ2FtZSBvYmplY3QgKHdpdGggYXR0cmlidXRlcyB0aGF0IHdpbGwgcHJlc2VydmUgdGhlIGdhbWUncyBzdGF0ZSwgaWUsIHdobyBoYXMgd2hhdCBjYXJkcykgYW5kIHRoZW5cbi8vIGFzayB0aGUgQVBJIGZvciBhIGRlY2sgSUQgdG8gYXNzaWduIHRvIHRoZSBnYW1lIG9iamVjdCdzIGRlY2sgKHdlIG5lZWQgdG8gdXNlIGl0IGZvciBzdWJzZXF1ZW50IGNhbGxzIHRvIHRoZSBBUEksIHdoZW4gd2UgYXNrIGl0IGZvciBjYXJkcyBmcm9tXG4vLyBvdXIgZGVjaykuXG4vLyBXZSBjYW4ndCBkbyBhbnl0aGluZyB1bnRpbCB3ZSBoYXZlIHRoYXQgZGVjayBJRCwgYnV0IHRoZSBwcm9ncmFtIHdvdWxkIGhhcHBpbHkgY29udGludWUgb24gcHJpb3IgdG8gYWN0dWFsbHkgbG9hZGluZyB0aGUgb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlXG4vLyBkZWNrIElELiBTbyB3ZSBuZWVkIGEgd2F5IHRvIG1ha2UgaXQgd2FpdCB1bnRpbCB0aGF0IG9iamVjdCBoYXMgc3VjY2Vzc2Z1bGx5IGxvYWRlZC0tIHdlIGRvIHNvIGJ5IG1ha2luZyB0aGUgbmV4dCBzdGVwIGluIHRoZSBwcm9ncmFtLCB3aGljaFxuLy8gaXMgdGhlIGRlYWxlcidzIGluaXRpYWwgdHVybiwgZmlyZSBhcyBwYXJ0IG9mIHRoZSBzZXREZWNrSUQgZnVuY3Rpb24ncyBjYWxsYmFjayBmdW5jdGlvbi4gVGhhdCB3YXkgaXQgd29uJ3QgaGFwcGVuIHVudGlsIGl0IGhhcyB0aGUgcmVxdWlzaXRlIGRhdGEuXG5mdW5jdGlvbiBzdGFydEdhbWUoKSB7XG4gIGdhbWUgPSBuZXcgR2FtZSgpO1xuICAkUExBWUVSQ09OVFJPTFMuZW1wdHkoKTtcbiAgJERFQUxFUkhBTkQuZW1wdHkoKTtcbiAgJFBMQVlFUkhBTkQuZW1wdHkoKTtcbiAgJE1TR0FSRUEuZW1wdHkoKTtcbiAgc2V0RGVja0lkKHBsYXllckluaXRpYWxUdXJuKTtcbn1cblxuLy8gc2V0dGluZyB1cCBhIGdhbWUgb2JqZWN0IHRvIHByZXNlcnZlIHRoZSBnYW1lJ3Mgc3RhdGUuIFRoaXMgaXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IGlzIGludm9rZWQgYWJvdmUgdmlhIFwiZ2FtZSA9IG5ldyBHYW1lKCk7XCIgdG9cbi8vIGdlbmVyYXRlIGEgZ2FtZSBvYmplY3Qgd2l0aCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgbGlzdGVkIGJlbG93LlxuZnVuY3Rpb24gR2FtZSgpIHtcbiAgdGhpcy5kZWNrX2lkID0gXCJcIjtcbiAgdGhpcy5kZWFsZXJfY2FyZHMgPSBbXTtcbiAgdGhpcy5wbGF5ZXJfY2FyZHMgPSBbXTtcbiAgdGhpcy5wbGF5ZXJ0b3RhbCA9IDA7XG4gIHRoaXMuZGVhbGVydG90YWwgPSAwO1xufVxuXG4vLyBzZXQgdGhlIHRoZSBnYW1lIG9iamVjdCdzIGRlY2tfaWQgYnkgY2FsbGluZyB0aGUgQVBJIGFuZCBsb29raW5nIGF0IHRoZSBkZWNrX2lkIGF0dHJpYnV0ZSBvZiB0aGUgcmVzcG9uc2UgaXQgZ2l2ZXMgdXMuXG4vLyBBZnRlciB0aGUgZGF0YSBoYXMgbG9hZGVkIChhbmQgd3JpdHRlbiB0byB0aGUgZ2FtZSBvYmplY3QpLCBvdXIgY2FsbGJhY2sgZnVuY3Rpb24gZmlyZXMgb2ZmLCB3aGljaCB3ZSd2ZSBzZXQgdXAgdG8gYmUgd2hhdGV2ZXIgZnVuY3Rpb24gd2UgcGFzcyBpbi5cbi8vIFdlIHBhc3MgaW4gcGxheWVySW5pdGlhbFR1cm4gKGxpbmUgNDQpIHNvIHRoYXQgdGhlIGdhbWUgc3RhcnRzLlxuXG5mdW5jdGlvbiBzZXREZWNrSWQoY2FsbGJhY2spIHtcbiAgJC5nZXQoQVBJX1BST1hZICsgQVBJX1VSTCArIFwiL3NodWZmbGUvP2RlY2tfY291bnQ9NlwiLCBmdW5jdGlvbihvYmope1xuICAgIGdhbWUuZGVja19pZCA9IG9iai5kZWNrX2lkO1xuICAgIGNhbGxiYWNrKCk7XG4gIH0sICdqc29uJyk7XG59XG5cbi8vIHNwZWNpZnkgXCJwbGF5ZXJcIiBvciBcImRlYWxlclwiIGFuZCBob3cgbWFueSBjYXJkcy4gVGhlaXIgYXJyYXkgd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCB0aGUgY2FyZHMgKHZpYSBhcnJheSBjb25jYXRlbmF0aW9uKVxuLy8gYW5kIHRoZSB0b3RhbCB1cGRhdGVkICh3aWxsIG1ha2UgQWNlcyB3b3J0aFxuLy8gMSBpbnN0ZWFkIG9mIDExIGlmIGl0IHdpbGwgcHJldmVudCBidXN0aW5nOyBzZWUgc3Vic2VxdWVudCBmdW5jdGlvbnMgZm9yIGRldGFpbHMgb24gaG93IHRoaXMgaGFwcGVucy5cbi8vIGh0dHA6Ly9kZWNrb2ZjYXJkc2FwaS5jb20vIHNob3dzIHdoYXQgdGhlIHJlc3BvbnNlIG9iamVjdCBsb29rcyBsaWtlOyBjaGVjayB1bmRlciBcImRyYXcgYSBjYXJkXCIuXG5mdW5jdGlvbiBkZWFsQ2FyZHModG93aG9tLCBudW0sIGNhbGxiYWNrKSB7XG4gIHZhciBnZXRfdXJsID0gQVBJX1BST1hZICsgQVBJX1VSTCArIFwiL2RyYXcvXCIgKyBnYW1lLmRlY2tfaWQgKyBcIi8/Y291bnQ9XCIgKyBudW07XG4gICQuZ2V0KGdldF91cmwsIGZ1bmN0aW9uKG9iail7XG4gICAgaWYgKHRvd2hvbS50b0xvd2VyQ2FzZSgpID09PSBcInBsYXllclwiKSB7XG4gICAgICBnYW1lLnBsYXllcl9jYXJkcyA9IGdhbWUucGxheWVyX2NhcmRzLmNvbmNhdChvYmouY2FyZHMpO1xuICAgICAgaW5zZXJ0UGxheWVyQ2FyZHMob2JqLmNhcmRzKTtcbiAgICAgIHVwZGF0ZVRvdGFsKFwicGxheWVyXCIpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGdhbWUuZGVhbGVyX2NhcmRzID0gZ2FtZS5kZWFsZXJfY2FyZHMuY29uY2F0KG9iai5jYXJkcyk7XG4gICAgICBpbnNlcnREZWFsZXJDYXJkcyhvYmouY2FyZHMpO1xuICAgICAgdXBkYXRlVG90YWwoXCJkZWFsZXJcIik7XG4gICAgfVxuICAgIGNhbGxiYWNrKCk7XG4gIH0sICdqc29uJyk7XG59XG5cbi8vIGVudGVyIFwicGxheWVyXCIgb3IgXCJkZWFsZXJcIi4gSXQgd2lsbCBzdW0gdXAgdGhlIHRvdGFsIG9mIHRoZSBjYXJkcyxcbi8vIHdpdGggYWNlcyBtb3ZlZCB0byB0aGUgYmFjayBzbyB0aGF0IHRoZSBjb21wdXRlciBjYW4gZGVjaWRlIHRvIGNvdW50IHRoZW0gYXNcbi8vIDEgaWYgaXQgd2lsbCBwcmV2ZW50IGJ1c3RpbmcuIFRoZSBuZXcgdG90YWwgaXMgd3JpdHRlbiB0byB0aGUgZ2FtZSBvYmplY3QuIFRoaXMgZG9lc24ndCBtb2RpZnkgdGhlIG9yaWdpbmFsXG4vLyBjYXJkIG9yZGVyOyBkb24ndCB3YW50IHRvIGRvIHRoYXQsIGJlY2F1c2Ugd2Ugd2FudCB0byBrZWVwIHRoZSBvcmRlciBmb3IgZGlzcGxheSBwdXJwb3Nlcy5cbi8vIHNvIGRvaW5nIC5zbGljZSgpIG9uIHRoZSBjYXJkIGFycmF5cyB3aWxsIGxldCB1cyBtYWtlIHRoZSBhY2VzVG9CYWNrLWVkIGFycmF5cyBmcm9tIGNvcGllcy5cbmZ1bmN0aW9uIHVwZGF0ZVRvdGFsKHdob20pIHtcbiAgdmFyIGNhcmRzID0gd2hvbS50b0xvd2VyQ2FzZSgpID09PSBcInBsYXllclwiID8gZ2FtZS5wbGF5ZXJfY2FyZHMuc2xpY2UoKSA6IGdhbWUuZGVhbGVyX2NhcmRzLnNsaWNlKCk7XG4gIHZhciB0b3RhbCA9XG4gIGFjZXNUb0JhY2soY2FyZHMpLnJlZHVjZShmdW5jdGlvbihhY2MsIGNhcmQpIHtcbiAgICBpZiAoY2FyZC52YWx1ZSA9PT0gXCJLSU5HXCIgfHwgY2FyZC52YWx1ZSA9PT0gXCJRVUVFTlwiIHx8IGNhcmQudmFsdWUgPT09IFwiSkFDS1wiKSB7XG4gICAgICByZXR1cm4gYWNjICsgMTA7XG4gICAgfVxuICAgIGVsc2UgaWYgKGNhcmQudmFsdWUgPT09IFwiQUNFXCIpIHtcbiAgICAgIGlmIChhY2MgKyAxMSA8IDIyKSB7cmV0dXJuIGFjYyArIDExfVxuICAgICAgZWxzZSB7cmV0dXJuIGFjYyArIDF9XG4gICAgfVxuICAgIGVsc2Uge3JldHVybiBhY2MgKyBwYXJzZUludChjYXJkLnZhbHVlKX1cbiAgfSwgMClcbiAgd2hvbS50b0xvd2VyQ2FzZSgpID09PSBcInBsYXllclwiID8gKGdhbWUucGxheWVydG90YWwgPSB0b3RhbCkgOiAoZ2FtZS5kZWFsZXJ0b3RhbCA9IHRvdGFsKTtcbn1cblxuLy8gYWNlcyB0byBiYWNrIG9mIGFycmF5IGZvciBzdW1tYXRpb24gcHVycG9zZXMuXG4vLyBMb29rIGF0IGFsbCBjYXJkczsgYWNlPyBJZiBzbyBtb3ZlIGl0IHRvIHRoZSBiYWNrLiBOb3QgYWNlPyBNb3ZlIGl0IHRvIHRoZSBmcm9udC5cbmZ1bmN0aW9uIGFjZXNUb0JhY2soYXJyKSB7XG4gIHZhciByZXR1cm5fYXJyID0gW107XG4gIGFyci5mb3JFYWNoKGZ1bmN0aW9uKGNhcmQpIHtcbiAgICBpZiAoY2FyZC52YWx1ZSA9PT0gXCJBQ0VcIikge3JldHVybl9hcnIucHVzaChjYXJkKX1cbiAgICBlbHNlIHtyZXR1cm5fYXJyLnVuc2hpZnQoY2FyZCl9XG4gIH0pXG4gIHJldHVybiByZXR1cm5fYXJyO1xufVxuXG4vLyBEZWFsZXIncyBmaXJzdCB0dXJuLiBEZWFsIDIgY2FyZHMgdG8gdGhlIGRlYWxlciwgYW5kIGFmdGVyIHRoZSBkYXRhIGlzIGxvYWRlZCwgaW52b2tlIGRlYWxlckxvb3AgYXMgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uLlxuLy8gTm90ZSB0aGF0IHRoZSBwbGF5ZXIgYWN0dWFsbHkgZ29lcyBmaXJzdDsgY29kZSBpcyBpbiB0aGlzIG9yZGVyIGJlY2F1c2UgSSBnb3QgdGhhdCB3cm9uZyBhdCBmaXJzdC5cbmZ1bmN0aW9uIGRlYWxlckluaXRpYWxUdXJuKCkge1xuICBkZWFsQ2FyZHMoXCJkZWFsZXJcIiwgMiwgZGVhbGVyTG9vcCk7XG59XG5cbi8vIE1ha2UgZGVhbGVyJ3MgdHVybnMgZ28gc2xvd2VyIChpZSwgbm90IGluc3RhbnRhbmVvdXNseSkgc28gdGhhdCBpdCBmZWVscyBsaWtlIGEgY2FyZCBnYW1lIGlzIGFjdHVhbGx5IGJlaW5nIHBsYXllZCBvdXQ7XG4vLyBkbyBzbyBieSBzZXR0aW5nIGEgdGltZW91dCBvbiBlYWNoIHN1YnNlcXVlbnQgZnVuY3Rpb24gY2FsbCAoaWUsIGVhY2ggKm5leHQqIGRlYWxlciB0dXJuKSB0aGF0IGRlbGF5cyB0aGF0IG5leHQgdHVybiBieVxuLy8gREVBTEVSX1RVUk5fREVMQVkgbWlsbGlzZWNvbmRzOyBhZGp1c3QgdGhpcyBjb25zdGFudCBmcm9tIHRoZSB0b3Agb2YgdGhpcyBmaWxlLlxuZnVuY3Rpb24gZGVhbGVyTG9vcCgpIHtcbiAgaWYgKGdhbWUuZGVhbGVydG90YWwgPCAxNykge1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ZGVhbENhcmRzKFwiZGVhbGVyXCIsIDEsIGRlYWxlckxvb3ApfSwgREVBTEVSX1RVUk5fREVMQVkpO1xuICB9IGVsc2Uge1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ZGVhbGVyVHVyblJlc3VsdCgpfSwgREVBTEVSX1RVUk5fREVMQVkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2UkUChzdHJpbmcpIHtcbiAgcmV0dXJuICgkKFwiPHA+XCIgKyBzdHJpbmcgKyBcIjwvcD5cIikuYWRkQ2xhc3MoXCJhbmltYXRlZCBmYWRlSW5cIikpO1xufVxuXG5mdW5jdGlvbiBkZWFsZXJUdXJuUmVzdWx0KCkge1xuICBpZiAoZ2FtZS5kZWFsZXJ0b3RhbCA9PT0gMjEpIHtcbiAgICBmbGlwRGVhbGVyQ2FyZHMoKVxuICAgICRNU0dBUkVBLmFwcGVuZChtYWtlJFAoXCJCbGFja2phY2shXCIpLnJlbW92ZUNsYXNzKFwiZmFkZUluXCIpLmFkZENsYXNzKFwiZmxhc2hcIikpLmFwcGVuZChtYWtlJFAoXCIgRGVhbGVyIHdpbnMhXCIpLmFkZENsYXNzKFwibG9zZVwiKSlcbiAgICBhcHBlbmROZXdHYW1lQnV0dG9uKCk7XG4gIH1cbiAgZWxzZSBpZiAoZ2FtZS5kZWFsZXJ0b3RhbCA+IDIxKSB7XG4gICAgZmxpcERlYWxlckNhcmRzKClcbiAgICAkTVNHQVJFQS5hcHBlbmQobWFrZSRQKFwiRGVhbGVyIGJ1c3RzIVwiKSkuYXBwZW5kKG1ha2UkUChcIiBZb3Ugd2luIVwiKS5hZGRDbGFzcyhcIndpblwiKSlcbiAgICBhcHBlbmROZXdHYW1lQnV0dG9uKCk7XG4gIH0gZWxzZSB7XG4gICAgZmluYWxSZWNrb25pbmcoKTtcbiAgfVxufVxuXG4vLyBwLiBtdWNoIHRoZSBzYW1lIHRoaW5nIGZvciB0aGUgcGxheWVyLCBleGNlcHQgaXQncyB1cCB0byBoaW0vaGVyIHdoZXRoZXIgb3Igbm90IHRvIGhpdC5cbmZ1bmN0aW9uIHBsYXllckluaXRpYWxUdXJuKCkge1xuICBkZWFsQ2FyZHMoXCJwbGF5ZXJcIiwgMiwgcGxheWVyTG9vcCk7XG59XG5cbmZ1bmN0aW9uIHBsYXllckxvb3AoKSB7XG4gIGZsaXBQbGF5ZXJDYXJkcygpO1xuICBpZiAoZ2FtZS5wbGF5ZXJ0b3RhbCA9PT0gMjEpIHtcbiAgICAkTVNHQVJFQS5hcHBlbmQobWFrZSRQKFwiQmxhY2tqYWNrIVwiKS5yZW1vdmVDbGFzcyhcImZhZGVJblwiKS5hZGRDbGFzcyhcImZsYXNoXCIpKS5hcHBlbmQobWFrZSRQKFwiIFlvdSB3aW4hXCIpLmFkZENsYXNzKFwid2luXCIpKTtcbiAgICBhcHBlbmROZXdHYW1lQnV0dG9uKCk7XG4gIH0gZWxzZSBpZiAoZ2FtZS5wbGF5ZXJ0b3RhbCA+IDIxKSB7XG4gICAgJE1TR0FSRUEuYXBwZW5kKG1ha2UkUChcIllvdSBidXN0ZWQhXCIpLnJlbW92ZUNsYXNzKFwiZmFkZUluXCIpLmFkZENsYXNzKFwic3dpbmdcIikpLmFwcGVuZChtYWtlJFAoXCIgWW91IGxvc2UhXCIpLmFkZENsYXNzKFwibG9zZVwiKSk7XG4gICAgYXBwZW5kTmV3R2FtZUJ1dHRvbigpO1xuICB9IGVsc2Uge1xuICAgICAgYXBwZW5kQ29udHJvbHNBbmRXYWl0KCk7XG4gIH1cbn1cbi8vIGlmIHRoZSBuZWl0aGVyIHRoZSBkZWFsZXIgbm9yIHRoZSBwbGF5ZXIgd29uIG91dHJpZ2h0IG9yIGJ1c3RlZCBkdXJpbmcgdGhlaXIgcmVzcGVjdGl2ZSB0dXJucywgd2UgbmVlZCB0byBjb21wYXJlIHRoZSB0b3RhbHNcbi8vIHRvIHNlZSB3aG8gd29uLlxuZnVuY3Rpb24gZmluYWxSZWNrb25pbmcoKSB7XG4gICRNU0dBUkVBLmFwcGVuZChtYWtlJFAoXCJZb3VyIHRvdGFsOiBcIiArIGdhbWUucGxheWVydG90YWwgKyBcIiZuYnNwOyAmbmJzcDsgRGVhbGVyJ3MgdG90YWw6IFwiICsgZ2FtZS5kZWFsZXJ0b3RhbCkpO1xuICBpZiAoZ2FtZS5wbGF5ZXJ0b3RhbCA+IGdhbWUuZGVhbGVydG90YWwpIHtcbiAgICBmbGlwRGVhbGVyQ2FyZHMoKVxuICAgICRNU0dBUkVBLmFwcGVuZChtYWtlJFAoXCJZb3Ugd2luIVwiKS5hZGRDbGFzcyhcIndpblwiKSk7XG4gICAgYXBwZW5kTmV3R2FtZUJ1dHRvbigpO1xuICB9IGVsc2UgaWYgKGdhbWUucGxheWVydG90YWwgPT09IGdhbWUuZGVhbGVydG90YWwpIHtcbiAgICBmbGlwRGVhbGVyQ2FyZHMoKVxuICAgICRNU0dBUkVBLmFwcGVuZChtYWtlJFAoXCJUaWUhIFlvdSBsb3NlIVwiKS5hZGRDbGFzcyhcImxvc2VcIikpO1xuICAgIGFwcGVuZE5ld0dhbWVCdXR0b24oKTtcbiAgfSBlbHNlIHtcbiAgICBmbGlwRGVhbGVyQ2FyZHMoKVxuICAgICRNU0dBUkVBLmFwcGVuZChtYWtlJFAoXCJZb3UgbG9zZSFcIikuYWRkQ2xhc3MoXCJsb3NlXCIpKTtcbiAgICBhcHBlbmROZXdHYW1lQnV0dG9uKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5zZXJ0UGxheWVyQ2FyZHMoY2FyZF9hcnIpIHtcbiAgY2FyZF9hcnIuZm9yRWFjaChmdW5jdGlvbihjYXJkX29iaikge1xuICAgIHZhciAkY2FyZCA9IGdlbmVyYXRlQmFjayRJTUcoY2FyZF9vYmopO1xuICAgICRQTEFZRVJIQU5ELmFwcGVuZCgkY2FyZCk7XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlRnJvbnQkSU1HKGNhcmRfb2JqKSB7XG4gIGlmIChjYXJkX29iai52YWx1ZSA9PT0gXCJBQ0VcIiAmJiBjYXJkX29iai5zdWl0ID09PSBcIkRJQU1PTkRTXCIpe1xuICAgIGNhcmRfb2JqLmltYWdlID0gXCJpbWFnZXMvQWNlT2ZEaWFtb25kcy5wbmdcIjtcbiAgfVxuICB2YXIgJGNhcmQgPSAkKFwiPGltZyBzcmM9J1wiICsgY2FyZF9vYmouaW1hZ2UgKyBcIic+XCIpO1xuICByZXR1cm4gJGNhcmQ7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlQmFjayRJTUcoY2FyZF9vYmopIHtcbiAgaWYgKGNhcmRfb2JqLnZhbHVlID09PSBcIkFDRVwiICYmIGNhcmRfb2JqLnN1aXQgPT09IFwiRElBTU9ORFNcIil7XG4gICAgY2FyZF9vYmouaW1hZ2UgPSBcImltYWdlcy9BY2VPZkRpYW1vbmRzLnBuZ1wiO1xuICB9XG4gIHZhciAkY2FyZCA9ICQoXCI8aW1nIHNyYz0nXCIgKyBDQVJEX0JBQ0tfVVJMICsgXCInIGZyb250X3VybCA9ICdcIiArIGNhcmRfb2JqLmltYWdlICsgXCInPlwiKTtcbiAgcmV0dXJuICRjYXJkO1xufVxuXG5mdW5jdGlvbiBpbnNlcnREZWFsZXJDYXJkcyhjYXJkX2Fycikge1xuICBjYXJkX2Fyci5mb3JFYWNoKGZ1bmN0aW9uKGNhcmRfb2JqLCBpKSB7XG4gICAgaWYgKCRERUFMRVJIQU5ELmlzKCc6ZW1wdHknKSAmJiBpID09PSAwKSB7XG4gICAgICB2YXIgJGNhcmQgPSBnZW5lcmF0ZUZyb250JElNRyhjYXJkX29iaik7XG4gICAgICAkREVBTEVSSEFORC5hcHBlbmQoJGNhcmQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgJGNhcmQgPSBnZW5lcmF0ZUJhY2skSU1HKGNhcmRfb2JqKTtcbiAgICAgICRERUFMRVJIQU5ELmFwcGVuZCgkY2FyZCk7XG4gICAgfVxuICB9KVxufVxuXG4vLyBmdW5jdGlvbiBhcHBlbmRUb3RhbCh3aG9tKSB7XG4vLyAgdmFyIHRvdGFsID0gd2hvbSA9PT0gXCJwbGF5ZXJcIiA/XG4vLyAgICBnYW1lLnBsYXllcnRvdGFsOlxuLy8gICAgZ2FtZS5kZWFsZXJ0b3RhbDtcbi8vICB2YXIgJG1zZ19hcmVhID0gd2hvbSA9PT0gXCJwbGF5ZXJcIiA/XG4vLyAgICAkUExBWUVSTVNHOlxuLy8gICAgJERFQUxFUk1TRztcbi8vICB2YXIgJHRvdGFsID0gJChcIjxwPlRvdGFsOiBcIiArIHRvdGFsICsgXCI8L3A+XCIpO1xuLy8gICRtc2dfYXJlYS5lbXB0eSgpO1xuLy8gICRtc2dfYXJlYS5hcHBlbmQoJHRvdGFsKTtcbi8vIH1cblxuLy8gYXBwZW5kIGNvbnRyb2xzIGFuZCBhd2FpdCBwbGF5ZXIgZGVjaXNpb25cbmZ1bmN0aW9uIGFwcGVuZENvbnRyb2xzQW5kV2FpdCgpIHtcbiAgJFBMQVlFUkNPTlRST0xTLmVtcHR5KCk7XG4gIHZhciAkaGl0ID0gJChcIjxidXR0b24gY2xhc3M9J2hpdC1idG4nPkhpdDwvYnV0dG9uPlwiKTtcbiAgdmFyICRzdGljayA9ICQoXCI8YnV0dG9uIGNsYXNzPSdzdGljay1idG4nPlN0YW5kPC9idXR0b24+XCIpO1xuICAkUExBWUVSQ09OVFJPTFMuYXBwZW5kKCRoaXQpLmFwcGVuZCgkc3RpY2spO1xufVxuXG5mdW5jdGlvbiBhcHBlbmROZXdHYW1lQnV0dG9uKCkge1xuICAkUExBWUVSQ09OVFJPTFMuZW1wdHkoKTtcbiAgdmFyICRuZXdnYW1lID0gJChcIjxidXR0b24gY2xhc3M9J25ld2dhbWUnPk5ldyBHYW1lPC9idXR0b24+XCIpO1xuICAkUExBWUVSQ09OVFJPTFMuYXBwZW5kKCRuZXdnYW1lKTtcbn1cblxuZnVuY3Rpb24gZmxpcERlYWxlckNhcmRzKCkge1xuICB2YXIgaW1nX2FyciA9IFtdLnNsaWNlLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5kZWFsZXItaGFuZCBpbWdcIikpO1xuICB2YXIgaSA9IDA7XG4gIHZhciBsZW5ndGggPSBpbWdfYXJyLmxlbmd0aDtcbiAgZnVuY3Rpb24gZGVsYXllZEZsaXAoKSB7XG4gICAgaWYgKGkgPCBsZW5ndGgpIHtcbiAgICAgIGlmIChpbWdfYXJyW2ldLmdldEF0dHJpYnV0ZShcImZyb250X3VybFwiKSkge1xuICAgICAgICBpbWdfYXJyW2ldLnNyYyA9IGltZ19hcnJbaV0uZ2V0QXR0cmlidXRlKFwiZnJvbnRfdXJsXCIpO1xuICAgICAgfVxuICAgICAgaSArPSAxO1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe2RlbGF5ZWRGbGlwKCl9LCBDQVNDQURFX0ZMSVBfVElNRSk7XG4gICAgfVxuICB9XG4gIGRlbGF5ZWRGbGlwKCk7XG59XG5cbmZ1bmN0aW9uIGZsaXBQbGF5ZXJDYXJkcygpIHtcbiAgdmFyIGltZ19hcnIgPSBbXS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIucGxheWVyLWhhbmQgaW1nXCIpKTtcbiAgdmFyIGkgPSAwO1xuICB2YXIgbGVuZ3RoID0gaW1nX2Fyci5sZW5ndGg7XG4gIGZ1bmN0aW9uIGRlbGF5ZWRGbGlwKCkge1xuICAgIGlmIChpIDwgbGVuZ3RoKSB7XG4gICAgICAgIGltZ19hcnJbaV0uc3JjID0gaW1nX2FycltpXS5nZXRBdHRyaWJ1dGUoXCJmcm9udF91cmxcIik7XG4gICAgfVxuICAgIGkgKz0gMTtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7ZGVsYXllZEZsaXAoKX0sIENBU0NBREVfRkxJUF9USU1FKTtcbiAgfVxuICBkZWxheWVkRmxpcCgpO1xufVxuIl19